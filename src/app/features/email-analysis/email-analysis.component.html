<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3>Analyse d'Email</h3>
        </div>
        <div class="card-body">
          <form [formGroup]="analysisForm" (ngSubmit)="analyzeEmail()">
            <!-- Sujet -->
            <div class="mb-3">
              <label for="subject" class="form-label">Sujet de l'email</label>
              <input
                type="text"
                class="form-control"
                id="subject"
                formControlName="subject"
                [ngClass]="{'is-invalid': analysisForm.get('subject')?.invalid && analysisForm.get('subject')?.touched}"
                placeholder="Entrez le sujet de l'email"
              >
              <div class="invalid-feedback" *ngIf="analysisForm.get('subject')?.errors?.['required']">
                Le sujet est requis
              </div>
            </div>

            <!-- Contenu -->
            <div class="mb-3">
              <label for="content" class="form-label">Contenu de l'email</label>
              <textarea
                class="form-control"
                id="content"
                rows="5"
                formControlName="content"
                [ngClass]="{'is-invalid': analysisForm.get('content')?.invalid && analysisForm.get('content')?.touched}"
                placeholder="Collez le contenu de l'email ici"
              ></textarea>
              <div class="invalid-feedback" *ngIf="analysisForm.get('content')?.errors?.['required']">
                Le contenu est requis
              </div>
              <div class="invalid-feedback" *ngIf="analysisForm.get('content')?.errors?.['minlength']">
                Le contenu doit contenir au moins 10 caractères
              </div>
            </div>

            <!-- Upload de fichier -->
            <div class="mb-3">
              <label for="file" class="form-label">Ou téléchargez un fichier email</label>
              <input
                type="file"
                class="form-control"
                id="file"
                (change)="onFileSelected($event)"
                accept=".eml,.msg,.txt"
              >
            </div>

            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="analysisForm.invalid || isAnalyzing"
              >
                <span *ngIf="isAnalyzing" class="spinner-border spinner-border-sm me-2" role="status"></span>
                {{ isAnalyzing ? 'Analyse en cours...' : 'Analyser' }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="resetForm()"
                [disabled]="isAnalyzing"
              >
                Réinitialiser
              </button>
            </div>
          </form>

          <!-- Conseils anti-phishing -->
          <div class="mt-4">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <i class="bi bi-shield-lock me-2"></i>Conseils anti-phishing
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li *ngFor="let tip of displayedTips">{{ tip }}</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Résultats de l'analyse -->
          <div *ngIf="analysisResult" class="mt-4">
            <div class="card">
              <div class="card-header">
                <h4>Résultats de l'analyse</h4>
              </div>
              <div class="card-body">
                <!-- Score de risque -->
                <div class="risk-score mb-3">
                  <h5>Score de risque</h5>
                  <div class="progress">
                    <div
                      class="progress-bar"
                      [ngClass]="{
                        'bg-success': analysisResult.riskScore < 50,
                        'bg-warning': analysisResult.riskScore >= 50 && analysisResult.riskScore < 75,
                        'bg-danger': analysisResult.riskScore >= 75
                      }"
                      [style.width.%]="analysisResult.riskScore"
                      role="progressbar"
                      [attr.aria-valuenow]="analysisResult.riskScore"
                      aria-valuemin="0"
                      aria-valuemax="100"
                      [attr.aria-label]="'Score de risque: ' + analysisResult.riskScore + '%'"
                      title="Score de risque de l'email"
                    >
                      {{ analysisResult.riskScore }}%
                    </div>
                  </div>
                </div>

                <!-- Statut -->
                <div class="alert" [ngClass]="{
                  'alert-success': !analysisResult.isPhishing,
                  'alert-danger': analysisResult.isPhishing
                }">
                  <strong>Statut :</strong>
                  {{ analysisResult.isPhishing ? 'Email suspect détecté' : 'Email sécurisé' }}
                </div>

                <!-- Liens -->
                <div *ngIf="analysisResult.links?.length" class="links-section mb-3">
                  <h5>Liens détectés</h5>
                  <ul class="list-group">
                    <li *ngFor="let link of analysisResult.links" class="list-group-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <span>{{ link.url }}</span>
                        <span class="badge" [ngClass]="{
                          'bg-success': !link.isSuspicious,
                          'bg-danger': link.isSuspicious
                        }">
                          {{ link.isSuspicious ? 'Suspect' : 'Sécurisé' }}
                        </span>
                      </div>
                    </li>
                  </ul>
                </div>

                <!-- Raisons -->
                <div class="mb-3">
                  <h5>Raisons</h5>
                  <ul *ngIf="reasons.length > 0">
                    <li *ngFor="let reason of reasons">{{ reason }}</li>
                  </ul>
                  <span *ngIf="reasons.length === 0" class="text-muted">Aucune raison spécifique détectée.</span>
                </div>

                <!-- Détails -->
                <div class="analysis-details mb-3">
                  <h5>Détails de l'analyse</h5>
                  <pre class="analysis-details-pre">{{ analysisResult.analysisDetails }}</pre>
                </div>

                <!-- Boutons d'export -->
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-outline-primary"
                    (click)="exportToPdf()"
                    [disabled]="isAnalyzing"
                  >
                    <i class="bi bi-file-pdf me-2"></i>Exporter en PDF
                  </button>
                  <button
                    class="btn btn-outline-secondary"
                    (click)="exportToCsv()"
                    [disabled]="isAnalyzing"
                  >
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exporter en CSV
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>